# CLAUDE.md

本文件为增强版Letta项目(本地贾维斯系统)提供指导，当在代码库中工作时使用。

## 本地贾维斯系统愿景

本项目致力于构建一个本地化的贾维斯系统，具备以下特性：
- **持续记忆**: 能够记住与用户的长期对话历史和个人偏好
- **个性化服务**: 根据用户习惯提供定制化服务
- **离线可用**: 核心功能可在本地运行，保护用户隐私
- **智能助手**: 集成日程管理、信息检索、任务执行等功能

## 增强计划

本项目在原始Letta基础上进行了增强，专注于以下两个方面：

### 1. 国内模型深度集成
- 增强对国内大模型的支持，包括Kimi、智谱AI、通义千问、文心一言等
- 优化国内网络环境下的API调用性能
- 提供针对中文场景的预设模板和工具

### 2. MCP工具生态系统扩展
- 增强MCP (Model Context Protocol) 工具集成能力
- 构建丰富的本地工具生态系统
- 支持自定义工具的快速开发和部署

## 常用开发命令

### 环境设置和安装
```
# 使用uv进行开发环境安装
uv sync --all-extras

# 运行Letta服务器(贾维斯模式)
uv run letta server

# 运行特定模式的服务器
uv run letta server --type rest --port 8283 --debug
uv run letta server --type rest --port 8283 --reload  # 开发模式
```

### 代码质量和格式化
```
# 使用ruff进行代码格式化
ruff format .

# 使用ruff进行代码检查
ruff check .

# 使用black进行格式化（已安装）
black .

# 使用pyright进行类型检查
pyright .
```

### 测试
```
# 运行所有测试
pytest

# 运行特定测试文件
pytest tests/path/to/test_file.py

# 运行带覆盖率的测试
pytest --cov=letta

# 运行异步测试
pytest -v --asyncio-mode=auto
```

### 数据库迁移
```
# 使用alembic进行数据库迁移
alembic upgrade head
alembic revision --autogenerate -m "描述"
```

## 详细架构图

### 1. 系统总体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户接口层                                │
├──────────────────┬──────────────────┬────────────────────────────┤
│   REST API      │   WebSocket API  │   OpenAI兼容接口            │
│  (FastAPI)      │   (实时通信)     │   (标准Chat Completions)   │
└──────────────────┴──────────────────┴────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                        业务逻辑层                                │
├──────────────────┬──────────────────┬────────────────────────────┤
│   AgentManager   │  ToolExecutor    │   MemoryManager           │
│   (代理管理器)    │  (工具执行器)     │   (记忆管理器)            │
├──────────────────┼──────────────────┼────────────────────────────┤
│  MessageManager  │   BlockManager   │   SourceManager           │
│   (消息管理器)    │  (记忆块管理器)   │   (数据源管理器)          │
└──────────────────┴──────────────────┴────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                        核心执行层                                │
├──────────────────┬──────────────────┬────────────────────────────┤
│   LettaAgent    │   MultiAgent      │   Temporal Workflow       │
│   (核心代理)     │   (多代理系统)     │   (工作流管理)            │
├──────────────────┼──────────────────┼────────────────────────────┤
│   LLMClient     │   ToolExecutor    │   Memory System           │
│   (LLM接口)      │  (工具执行器)     │   (记忆系统)              │
└──────────────────┴──────────────────┴────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                        数据持久层                                │
├──────────────────┬──────────────────┬────────────────────────────┤
│     ORM层       │    数据库连接     │     缓存系统              │
│  (SQLAlchemy)   │   (PostgreSQL/   │     (Redis/内存)           │
│                 │    SQLite)       │                           │
└──────────────────┴──────────────────┴────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                        外部服务层                                │
├──────────────────┬──────────────────┬────────────────────────────┤
│   LLM提供商      │   工具服务       │     监控系统              │
│ (OpenAI/AWS等)  │ (Composio/MCP)  │     (Sentry/OTel)         │
└──────────────────┴──────────────────┴────────────────────────────┘
```

### 2. 代理系统详细架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        代理接口层                                │
├─────────────────────────────────────────────────────────────────┤
│                BaseAgent / BaseAgentV2                           │
│                (抽象代理基类)                                    │
└─────────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                        代理实现层                                │
├──────────────────┬──────────────────┬────────────────────────────┤
│   LettaAgent     │   LettaAgentV2   │   EphemeralAgent         │
│   (标准代理)     │   (改进版代理)    │   (临时代理)              │
├──────────────────┼──────────────────┼────────────────────────────┤
│   VoiceAgent     │  SleeptimeAgent  │   BatchAgent             │
│   (语音代理)     │  (睡眠代理)      │   (批量代理)              │
└──────────────────┴──────────────────┴────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                        代理循环层                                │
├─────────────────────────────────────────────────────────────────┤
│                    AgentLoop                                     │
│                (代理执行循环)                                    │
├─────────────────────────────────────────────────────────────────┤
│  1. 构建上下文  →  2. 调用LLM  →  3. 解析响应  →  4. 执行工具   │
└─────────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                        工作流集成层                              │
├─────────────────────────────────────────────────────────────────┤
│                TemporalAgentWorkflow                            │
│                (Temporal工作流集成)                              │
├─────────────────────────────────────────────────────────────────┤
│  Activities:  │  PrepareMessages  │  ExecuteLLM  │  RunTools   │
└──────────────────┴──────────────────┴────────────────────────────┘
```

### 3. 工具系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        工具定义层                                │
├──────────────────┬──────────────────┬────────────────────────────┤
│   Letta Core    │   Memory Tools   │   Built-in Tools          │
│   (核心工具)     │   (记忆工具)      │   (内置工具)              │
├──────────────────┼──────────────────┼────────────────────────────┤
│   Composio       │   MCP Tools      │   Custom Tools            │
│   (外部工具)     │   (协议工具)      │   (自定义工具)            │
└──────────────────┴──────────────────┴────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                        工具加载层                                │
├─────────────────────────────────────────────────────────────────┤
│                ToolRegistry                                    │
│                (工具注册表)                                      │
├─────────────────────────────────────────────────────────────────┤
│  动态加载  →  Schema解析  →  验证注册  →  索引构建               │
└─────────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                        工具执行层                                │
├──────────────────┬──────────────────┬────────────────────────────┤
│   ToolExecutor   │   Sandbox        │   MultiAgent             │
│   (标准执行器)    │   (沙箱执行器)    │   (多代理执行器)          │
├──────────────────┼──────────────────┼────────────────────────────┤
│   ExecutionMgr   │   Factory        │   Error Handler           │
│   (执行管理器)    │   (工厂方法)      │   (错误处理)              │
└──────────────────┴──────────────────┴────────────────────────────┘
```

### 4. 记忆系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        记忆接口层                                │
├─────────────────────────────────────────────────────────────────┤
│                Memory / MemoryManager                           │
│                (记忆管理接口)                                    │
└─────────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                        记忆实现层                                │
├──────────────────┬──────────────────┬────────────────────────────┤
│   CoreMemory     │   ArchivalMemory │   RecallMemory           │
│   (核心记忆)     │   (档案记忆)      │   (回忆记忆)              │
├──────────────────┼──────────────────┼────────────────────────────┤
│   MemoryBlock    │   BlockManager   │   MemorySearch           │
│   (记忆块)       │   (块管理器)      │   (记忆搜索)              │
└──────────────────┴──────────────────┴────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                        存储抽象层                                │
├──────────────────┬──────────────────┬────────────────────────────┤
│   Embedding      │   VectorStore    │   Persistence            │
│   (嵌入编码)     │   (向量存储)      │   (持久化)                │
├──────────────────┼──────────────────┼────────────────────────────┤
│   Serializer     │   Compressor     │   Summarizer             │
│   (序列化)       │   (压缩器)        │   (摘要器)                │
└──────────────────┴──────────────────┴────────────────────────────┘
```

## 发布计划

### Alpha版本 (第4周)
- **目标**: 核心功能可用，基础国内模型支持
- **包含功能**:
  - Kimi和Zhipu AI模型支持
  - 基础MCP工具集（文件操作、时间获取、网络搜索）
  - 基本的Letta代理功能
- **目标用户**: 开发者和早期测试用户
- **发布渠道**: GitHub Releases

### Beta版本 (第8周)
- **目标**: 功能完整，稳定性提升
- **包含功能**:
  - 完整的国内模型支持（Qwen、ERNIE Bot等）
  - 丰富的MCP工具生态系统
  - 记忆增强模块
  - 离线功能支持
- **目标用户**: 公开测试用户
- **发布渠道**: GitHub Releases, Docker Hub

### 正式版本 (第10周)
- **目标**: 生产就绪，文档完善
- **包含功能**:
  - 所有计划功能
  - 完整的文档和示例
  - 可视化管理界面
  - 性能优化和错误处理
- **目标用户**: 所有用户
- **发布渠道**: GitHub Releases, Docker Hub, PyPI

## 部署和安装

### 系统要求
- Python 3.11+
- uv包管理器
- PostgreSQL (可选，用于持久化存储)
- Docker (可选，用于容器化部署)

### 安装步骤
1. 克隆项目仓库
2. 安装依赖: `uv sync --all-extras`
3. 配置环境变量 (API密钥等)
4. 启动服务: `uv run letta server`

### 配置说明
- `.env` 文件包含所有必要的配置项
- 支持通过环境变量覆盖配置
- 提供Docker Compose配置用于容器化部署

## 版本管理

### 版本号格式
采用语义化版本控制 (SemVer): `主版本号.次版本号.修订号`

### 分支策略
- `main`: 稳定版本分支
- `develop`: 开发版本分支
- `feature/*`: 功能开发分支
- `hotfix/*`: 紧急修复分支

## 社区和贡献

### 贡献指南
- 遵循项目的代码风格和规范
- 提交Pull Request前进行充分测试
- 提供清晰的提交信息和变更说明

### 问题反馈
- 使用GitHub Issues报告问题
- 提供详细的环境信息和复现步骤
- 标记问题的优先级和类型

## 开发注意事项

### 代码风格
- 使用ruff进行代码格式化和检查（配置见pyproject.toml）
- 行长度限制为140字符
- 使用双引号和空格缩进

### 测试策略
- 测试位于`tests/`目录
- 使用pytest和pytest-asyncio进行异步测试
- 遵循arrange-act-assert模式

### 数据库工作
- 使用alembic进行数据库迁移
- 迁移文件位于`alembic/versions/`
- 开发时默认使用SQLite

### 配置管理
- 环境变量通过`.env`文件配置
- 主要配置位于`letta/settings.py`
- 支持多种LLM提供商配置

### CLI工具
- 主要CLI入口: `letta main.py`
- 服务器管理: `letta server`
- 工具加载: `letta load